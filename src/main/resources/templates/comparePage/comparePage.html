<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>

</head><link rel="stylesheet" type="text/css" href="/resources/css/comparePriceStyle.css">

<body>
<img src="/resources/image/page_background.png" class="page-background">
<div id="compare-page">
  <div class="menu-wrapper">
    <img src="/resources/image/recipick_logo.png" alt="Recipick 메뉴바" class="menu-logo">
    <div class="menu-buttons">
      <button class="menu-btn" onclick="location.href='/recipick/cards'">레시피검색</button>
      <button class="menu-btn" onclick="location.href='/recipick/mapPage'">내 동네시장</button>
      <button class="menu-btn" onclick="location.href='/recipick/mapPage?from=compare'">비교장보기</button>
    </div>
  </div>

  <div class="page-header">
    <p class="page-subtitle">총 가격이 더 저렴한 가게를 비교해요</p>
    <h3>마트별 비교 장보기</h3>
  </div>

  <div class="total-table-wrapper">
    <!-- 왼쪽 테이블 -->
    <div class="table-wrapper">
      <img src="/resources/image/recipe_background.png" class="bg-img">
      <button class="table-title-button" :class="getLeftTextClass()" :disabled="!isActivated" @click="goToMap(martAName)"> {{ firstTitle }} </button>
      <div class="table-content">
        <table>
          <tbody>
          <tr v-for="(item, index) in leftItems" :key="index">
            <td :class="getLeftTextClass()">{{ item.name }} <span v-if="page == 2">({{ item.quantity }}개)</span></td>
            <td :class="getLeftTextClass()">{{ item.price.toLocaleString() }}</td>
            <td v-if="page != 2">
              <div class="quantity-control">
                <button class="quantity-button" @click.stop="decreaseQuantity(index)">-</button>
                <button class="quantity-button" @click.stop="increaseQuantity(index)">+</button>
              </div>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
      <div class="table-footer">
        <table>
          <tfoot>
          <tr v-if = "page == 2">
            <td :class="getLeftTextClass()">총 금액: {{ leftTotal }}원</td>
          </tr>
          <tr v-else>
            <td :class="getLeftTextClass()" style="font-size: 16px;">필요한 재료를 담고, 왼쪽의 <span style="color: #0000FF;">총 구매 금액(영수증)</span>을 확인해보세요</td>
          </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- 오른쪽 테이블 -->
    <div class="table-wrapper">
      <img src="/resources/image/recipe_background.png" class="bg-img">
      <button class="table-title-button" :class="getRightTextClass()" :disabled="!isActivated" @click="goToMap(martBName)"> {{ secondTitle }} </button>
      <div class="table-content">
        <table>
          <tbody>
          <tr v-for="(item, index) in rightItems" :key="'r' + index">
            <td :class="getRightTextClass()">{{ item.name }} ({{ item.quantity }}개)</td>
            <td :class="getRightTextClass()">{{ (item.price * item.quantity).toLocaleString() }}</td>
            <td>
              <button class="quantity-button" @click.stop="removeFromRight(index)" v-if="page !== 2">x</button>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
      <div class="table-footer">
        <table>
          <tfoot>
          <tr><td :class="getRightTextClass()">총 금액: {{ rightTotal }}원</td></tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <div class="nav-button-wrapper">
    <div class="prev-button-box">
      <button class="nav-button" @click="toPrev" :disabled="clickCount == 0">이전</button>
    </div>
    <div class="next-button-box" v-if="page !== 2">
      <button class="nav-button" @click="toNext">다음</button>
    </div>
  </div>
</div>

<script>
  new Vue({
    el: '#compare-page',
    data: {
      PAGE_COUNT: 3,
      clickCount: 0,
      itemA: [],
      itemB: [],
      recipeA: [],
      recipeB: [],
      martAName: '',
      martBName: ''
    },
    created() {
      this.martAName = localStorage.getItem("mart1");
      this.martBName = localStorage.getItem("mart2");
      this.fetchItems();
    },
    computed: {
      page() {
        return this.clickCount % this.PAGE_COUNT;
      },
      isActivated() {
        return this.page == 2;
      },
      leftItems() {
        if (this.page == 0) return this.itemA;
        else if (this.page == 1) return this.itemB;
        else return this.recipeA;
      },
      rightItems() {
        return this.page == 0 ? this.recipeA : this.recipeB;
      },
      leftTotal() {
        return this.leftItems.reduce((sum, item) => sum + (item.price * item.quantity), 0).toLocaleString();
      },
      rightTotal() {
        return this.rightItems.reduce((sum, item) => sum + (item.price * item.quantity), 0).toLocaleString();
      },
      firstTitle() {
        if (this.page == 0) return `${this.martAName} 장보기`;
        else if (this.page == 1) return `${this.martBName} 장보기`;
        else return `${this.martAName} 영수증`;
      },
      secondTitle() {
        if (this.page == 0) return `${this.martAName} 영수증`;
        else return `${this.martBName} 영수증`;
      }
    },
    methods: {
      increaseQuantity(index) {
        const item = this.leftItems[index];
        const targetList = this.page === 0 ? this.recipeA : this.recipeB;
        const existing = targetList.find(el => el.name === item.name);
        if (existing) {
          existing.quantity++;
        } else {
          targetList.push({ ...item, quantity: 1 });
        }
      },
      decreaseQuantity(index) {
        const item = this.leftItems[index];
        const targetList = this.page === 0 ? this.recipeA : this.recipeB;
        const existingIndex = targetList.findIndex(el => el.name === item.name);
        if (existingIndex !== -1) {
          const existing = targetList[existingIndex];
          existing.quantity--;
          if (existing.quantity <= 0) targetList.splice(existingIndex, 1);
        }
      },
      removeFromRight(index) {
        if (this.page === 0) this.recipeA.splice(index, 1);
        else this.recipeB.splice(index, 1);
      },
      toNext() {
        this.clickCount++;
        this.selectedIndex = null;
        this.fetchItems();
      },
      toPrev() {
        if (this.clickCount > 0) {
          this.clickCount--;
          this.selectedIndex = null;
          this.fetchItems();
        }
      },
      fetchItems() {
        const martName = this.page === 0 ? this.martAName : this.page === 1 ? this.martBName : null;
        if (!martName) return;
        fetch(`/recipick/mart-items?martName=${encodeURIComponent(martName)}`)
          .then(res => res.json())
          .then(data => {
            const items = data.map(d => ({ name: d.aName, price: d.aPrice, quantity: 1 }));
            if (this.page === 0) this.itemA = items;
            else if (this.page === 1) this.itemB = items;
          });
      },
      goToMap(martName) {
        if (this.page !== 2) return;
        const url = `/recipick/mapPage?highlight=${encodeURIComponent(martName)}`;
        window.location.href = url;
      },
      getLeftTextClass() {
        // 페이지 0 또는 1일 때는 검정
        return (this.page === 0 || this.page === 1 || this.page === 2) ? 'text-black' : 'text-blue';
      },
      getRightTextClass() {
        return this.page === 2 ? 'text-black' : 'text-blue';
      }
    }
  });
</script>
</body>
</html>
